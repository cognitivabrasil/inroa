#!/bin/bash

FULLNEWVERSION=$(cat /etc/feb/version)
NEWVERSION=${FULLNEWVERSION:0:3}

echo "New version ${FULLNEWVERSION}"

case "$1" in
	configure)

	if [ -z "$2" ]; then
		echo "New installation"
		echo "Creating user"
		
		echo "Creating database schema..."
		sudo -u postgres psql -f /usr/share/FEB/schema.sql >> /tmp/instalacao_feb.log;
		echo "Populating database..."
		sudo -u postgres psql federacao -f /usr/share/FEB/data.sql >> /tmp/instalacao_feb.log;
	else
		FULLOLDVERSION=$2
		OLDVERSION=${FULLOLDVERSION:0:3}
		if [[ "$OLDVERSION" < "2.2" ]]; then
			echo "Atualizando de versão anterior à 2.2"
			echo "Apagando base e recriando..."
			
			sudo -u postgres dropdb federacao >> /tmp/instalacao_feb.log;
			sudo -u postgres psql -f /usr/share/FEB/schema.sql >> /tmp/instalacao_feb.log;
			sudo -u postgres psql federacao -f /usr/share/FEB/data.sql >> /tmp/instalacao_feb.log;
		elif [ "$OLDVERSION" = "$NEWVERSION" ]; then
			echo "Same major-minor, no database change"
		else
			echo "Standard upgrade procedure..."
			echo "Upgrading from $OLDVERSION to $NEWVERSION"
			sudo -u postgres psql -f /usr/share/FEB/upgrade${OLDVERSION}to${NEWVERSION}
		fi
	fi

sudo service postgresql restart > instalacao_feb.log;

;;

  abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

